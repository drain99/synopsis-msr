\begin{figure}[H]
\begin{algorithm}[H]
\begin{footnotesize}
\SetAlgoLined
\SetKwProg{Fn}{Function}{}{end}
\Fn{$\Theta_D(p_a,e_a,p_b,e_b,d)$}{
  $R \mapsfrom \emptyset$;\\
  $S \mapsfrom \Theta_D(p_a,e_a,p_b,e_b,d)$;\\
  \lIf{$S = \cons{Fail}$}{\Return{$\cons{Fail}$}}
  \ForEach{$\corrtuple{p_1}{a_1}{p_2}{e_2}_{d'} \keyword{in} S$}{
    \uIf{$e_2 \keyword{is} atomic$}{
      \uIf{$d' \leq D \keyword{and} a_1 \keyword{is\ not} scalar$}{
        $e_1 \mapsfrom rewrite(a_1)$;\\
        $e_2^r \mapsfrom rewrite(e_2)$;\\
        $R_1 \mapsfrom \Theta_D(p_1,e_1,p_2,e_2^r,d')$
        \lIf{$R_1 = \cons{Fail}$}{\Return{$\cons{Fail}$}}
        $R \mapsfrom R \cup R_1$;\\
      }
      \Else{
        $R \mapsfrom R \cup \{ \corrtuple{p_1}{a_1}{p_2}{e_2}_{d'} \}$;\\
      }
    }
    \Else{
      $e_1 \mapsfrom rewrite(a_1)$;\\
      $R_1 \mapsfrom \Theta_D(p_1,e_1,p_2,e_2,d')$;\\
      \lIf{$R_1 = \cons{Fail}$}{\Return{$\cons{Fail}$}}
      $R \mapsfrom R \cup R_1$;\\
    }
  }
  \Return{$\cons{Succ}(R)$};
}
\end{footnotesize}
\caption{\label{algo:dunifyandrewrite}Pseudo-code for $D$-Depth Iterative Unification and Rewriting Procedure}
\end{algorithm}
\end{figure}